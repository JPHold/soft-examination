[TOC]

> 阐述了流水线的原理、效率、耗时时间公式、吞吐率公式


# 普通流水线
## 概念
> 多条指令交替执行的**准并行**处理技术
> 为何是准并行：并不是同时执行多条指令，而是在某个时刻，a指令执行到b1步骤、b指令执行执行a1步骤，假如a指令一直塞在b1步骤，那么b指令只能等待（**所以其实是串行执行**）

## 指令的执行过程
取指→分析→执行
下面的执行图，1️⃣、2️⃣等这些标识，代表当前指令；横向是耗时，经过时间推移，指令会走到对应的步骤上

* 假设取指、分析、执行的耗时都是1ms
1. 不采用流水线
>现在有三条指令需要执行
>**必须等上一条指令完成执行，才执行下一条指令**，所以总耗时 = `每个步骤的总耗时* 指令数` =` (1 * 3) * 3 = 9`(ms) 

|      |     |     |     |     |     |     |     |     |     |
| ---- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 取指 | 1️⃣ |     |     | 2️⃣ |     |     | 3️⃣ |     |     |
| 分析 |     | 1️⃣ |     |     | 2️⃣ |     |     | 3️⃣ |     |
| 执行 |     |     | 1️⃣ |     |     | 2️⃣ |     |     | 3️⃣ |
| 耗时 | 1   | 2   | 3   | 4   | 5   | 6   | 7   | 8   | 9   |


2. 采用流水线
>现在有三条指令需要在流水线执行
>**无须等上一条指令完成执行，才执行下一条指令，只要有空余步骤，就立马给下个指令安排操作**，所以总耗时 = 第一个指令的每个步骤的总耗时 + 剩余指令数 * 步骤中最长耗时 = (1 * 3)  + 2 * 1  = 5(ms) 

|      |     |     |     |     |     |
| ---- | --- | --- | --- | --- | --- |
| 取指 | 1️⃣ | 2️⃣ | 3️⃣ |     |     |
| 分析 |     | 1️⃣ | 2️⃣ | 3️⃣ |     |
| 执行 |     |     | 1️⃣ | 2️⃣ | 3️⃣ |
| 耗时 | 1   | 2   | 3   | 4   | 5   |

### 得出公式

步骤中最长耗时，其实叫流水线周期，涉及到一个概念：
所有步骤中，哪个步骤的耗时最长，即为流水线周期，记作 ∆t

因此流水线的耗时计算公式：第一条指令的耗时+(指令条数-1) \*  ∆t
具体可分为如下公式（只是第一条指令的耗时计算不同，实践公式中每个步骤的耗时都采用流水周期）

下面会以界面化，清晰区分这种公式的差别（以两条命令为例，**三个步骤的耗时分别是：1、2、3**），会发现实践公式的流水线图，每个步骤都会占用3个耗时，导致闲置时间过长，比理论公式多出3个耗时

1. ** 理论公式**
第一条指令耗时（每个步骤 * 自己的耗时，再相加）+(指令条数-1) \*  流水线周期

`(t1 + t2 + t3 + ... + tk) + (n-1)  *  ∆t`

|      |     |     |     |     |     |     |     |     |     |
| ---- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 取指 | 1️⃣ | 2️⃣ |     |     |     |     |     |     |     |
| 分析 |     | 1️⃣ | 1️⃣ | 2️⃣ | 2️⃣ |     |     |     |     |
| 执行 |     |     |     | 1️⃣ | 1️⃣ | 1️⃣ | 2️⃣ | 2️⃣ | 2️⃣ |
| 耗时 | 1   | 2   | 3   | 4   | 5   | 6   | 7   | 8   | 9   |

2. **实践公式**
第一条指令耗时（每个步骤 * 流水线周期，再相加）+(指令条数-1) \*  流水线周期

`(k * ∆t) + (n-1) * ∆t`

|      |     |     |     |     |     |     |     |     |     |     |     |     |
| ---- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 取指 | 1️⃣ | 1️⃣ | 1️⃣ | 2️⃣ | 2️⃣ | 2️⃣ |     |     |     |     |     |     |
| 分析 |     |     |     | 1️⃣ | 1️⃣ | 1️⃣ | 2️⃣ | 2️⃣ | 2️⃣ |     |     |     |
| 执行 |     |     |     |     |     |     | 1️⃣ | 1️⃣ | 1️⃣ | 2️⃣ | 2️⃣ | 2️⃣ |
| 耗时 | 1   | 2   | 3   | 4   | 5   | 6   | 7   | 8   | 9   | 10  | 11  | 12  |

## 吞吐率计算
### 概念
>Though Put rate，TP
>在单位时间内完成的任务数量

### 公式
* 基本公式

`TP = 指令数量 / 流水线的总执行时间（第一条指令耗时+剩余指令耗时）`
`TP = n /( (t1 + t2 + t3 + ... + tk) + (n-1)  *  ∆t)`

* 最大吞吐率
记n趋近于无穷大，所有步骤都采用同一个耗时（流水线周期）
k为第一条指令
`TP = n / (k + n-1) * ∆t `
**其实n = (k+n-1)，所以公式化简后：**
`TP =1 / ∆t`

# 超标量流水线
> 有两条流水线同时工作，**有个度的概念，2条流水线即叫度为2**

* 假设每个步骤的耗时都是1ms
可以发现1和2、3和4、5和6都是同时执行

|      |     |     |     |     |     |     |     |     |     |
| ---- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 取指 | 1   | 3   | 5   | .   | .   | .   |n-1     |  |     |
| 取指 | 2   | 4   | 6   | .   | .   | .   |n     |     |     |
| 分析 |     | 1   | 3   | 5   | .   | .   | .   |n-1     |     |
| 分析 |     | 2   | 4   | 6   | .   | .   | .   |n     |     |
| 执行 |     |     | 1   | 3   | 5   | .   | .   |.     |n-1     |
| 执行 |     |     | 2   | 4   | 6   | .   | .   | .   |n     |

